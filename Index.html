<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Hardship Profile Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-tiny {
             width: 1rem;
             height: 1rem;
             border-width: 2px;
             border-style: solid;
             border-color: #9CA3AF; /* gray-400 */
             border-top-color: transparent;
             border-radius: 50%;
             animation: spin 0.8s linear infinite;
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Persona Hardship Profile Generator</h1>
            <p class="text-md text-gray-600 mt-2">Create a realistic persona profile facing financial challenges.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-3">Financial Details</h2>
                <form id="persona-form" class="space-y-4">
                    
                    <div>
                        <label for="hardship-reason" class="block text-sm font-medium text-gray-700">Reason for Hardship</label>
                        <select id="hardship-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option>Reduced Hours at Work</option>
                            <option>Job Loss</option>
                            <option>Medical Emergency</option>
                            <option>Unexpected Home/Auto Repair</option>
                            <option>Divorce / Separation</option>
                            <option>Caring for a Family Member</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <div>
                        <label for="income-slider" class="block text-sm font-medium text-gray-700">Monthly Income: <span id="income-value" class="font-bold text-indigo-600">$2500</span></label>
                        <input type="range" id="income-slider" min="0" max="10000" value="2500" step="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div id="income-surplus-indicator" class="text-center text-sm font-medium mt-2 p-2 rounded-md"></div>
                    </div>

                     <div class="pt-4 border-t">
                         <label for="zip-code" class="block text-sm font-medium text-gray-700">Zip Code for Expense Estimates</label>
                         <input type="text" id="zip-code" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., 90210">
                         <p id="zip-error" class="text-xs text-red-600 mt-1 hidden"></p>
                    </div>

                    <div class="pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700">Add Expenses (Upload or Paste)</label>
                        <div class="mt-2">
                            <input type="file" id="expense-file-input" class="hidden" accept=".txt">
                            <label for="expense-file-input" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 cursor-pointer">
                               <span>Choose File</span>
                            </label>
                            <span id="file-name" class="ml-3 text-sm text-gray-500">No file chosen</span>
                        </div>
                        <div class="mt-2">
                             <textarea id="paste-expenses" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Or paste expenses here..."></textarea>
                             <button type="button" id="parse-paste-btn" class="mt-2 w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Parse Pasted Text
                             </button>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold pt-4 border-t mt-6">Monthly Expenses</h3>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-5">
                        <!-- Expense inputs will be dynamically populated -->
                        <div><label for="rent" class="block text-sm font-medium text-gray-700">Rent / Mortgage</label><input type="number" id="rent" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="vehicle-payment" class="block text-sm font-medium text-gray-700">Vehicle Payment</label><input type="number" id="vehicle-payment" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="auto-insurance" class="block text-sm font-medium text-gray-700">Auto Insurance</label><input type="number" id="auto-insurance" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="fuel" class="block text-sm font-medium text-gray-700">Fuel</label><input type="number" id="fuel" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        
                        <div class="col-span-1 sm:col-span-2"><hr class="my-2"></div>
                        <div>
                            <label for="utilities" class="block text-sm font-medium text-gray-700">Electricity & Gas</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="utilities" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0">
                                <button type="button" class="get-avg-btn p-2 rounded-md bg-gray-100 hover:bg-gray-200" data-type="Electricity & Gas" data-target="utilities"><span class="spinner-tiny hidden"></span><span>Get Avg</span></button>
                            </div>
                        </div>
                        <div>
                            <label for="water" class="block text-sm font-medium text-gray-700">Water / Sewer / Trash</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="water" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0">
                                <button type="button" class="get-avg-btn p-2 rounded-md bg-gray-100 hover:bg-gray-200" data-type="Water / Sewer / Trash" data-target="water"><span class="spinner-tiny hidden"></span><span>Get Avg</span></button>
                            </div>
                        </div>

                        <div class="col-span-1 sm:col-span-2"><hr class="my-2"></div>
                        <div>
                            <label for="internet" class="block text-sm font-medium text-gray-700">Internet / Cable</label>
                            <input type="text" id="internet-brand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="Brand (e.g., Verizon)">
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="number" id="internet" class="expense-input block w-full rounded-md border-gray-300 shadow-sm" placeholder="0">
                                <button type="button" class="get-avg-btn p-2 rounded-md bg-gray-100 hover:bg-gray-200" data-type="Internet" data-target="internet" data-brand-source="internet-brand"><span class="spinner-tiny hidden"></span><span>Get Plans</span></button>
                            </div>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Cell Phone</label>
                            <input type="text" id="phone-brand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="Brand (e.g., T-Mobile)">
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="number" id="phone" class="expense-input block w-full rounded-md border-gray-300 shadow-sm" placeholder="0">
                                <button type="button" class="get-avg-btn p-2 rounded-md bg-gray-100 hover:bg-gray-200" data-type="Cell Phone" data-target="phone" data-brand-source="phone-brand"><span class="spinner-tiny hidden"></span><span>Get Plans</span></button>
                            </div>
                        </div>
                        <div class="col-span-1 sm:col-span-2"><hr class="my-2"></div>

                        <!-- Other Expenses -->
                        <div><label for="groceries" class="block text-sm font-medium text-gray-700">Groceries & Hygiene</label><input type="number" id="groceries" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="dining" class="block text-sm font-medium text-gray-700">Dining Out</label><input type="number" id="dining" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="health-insurance" class="block text-sm font-medium text-gray-700">Health Insurance</label><input type="number" id="health-insurance" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="prescriptions" class="block text-sm font-medium text-gray-700">Prescriptions</label><input type="number" id="prescriptions" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="family-support" class="block text-sm font-medium text-gray-700">Family Support</label><input type="number" id="family-support" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="taxes" class="block text-sm font-medium text-gray-700">Past Due Taxes</label><input type="number" id="taxes" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="grooming" class="block text-sm font-medium text-gray-700">Grooming</label><input type="number" id="grooming" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="pets" class="block text-sm font-medium text-gray-700">Pets</label><input type="number" id="pets" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="charity" class="block text-sm font-medium text-gray-700">Charity</label><input type="number" id="charity" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="savings" class="block text-sm font-medium text-gray-700">Savings</label><input type="number" id="savings" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="recreation" class="block text-sm font-medium text-gray-700">Recreation/Gym</label><input type="number" id="recreation" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                        <div><label for="credit-cards" class="block text-sm font-medium text-gray-700">Credit Card Payments</label><input type="number" id="credit-cards" class="expense-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0"></div>
                    </div>

                    <div class="pt-5">
                        <button type="submit" id="generate-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Generate Profile
                        </button>
                    </div>
                </form>
            </div>

            <!-- Output Profile -->
            <div id="profile-output" class="bg-white p-6 rounded-lg shadow-md hidden">
                 <div id="loader" class="loader mx-auto my-12 hidden"></div>
                 <div id="profile-content"></div>
            </div>
        </main>
    </div>

    <!-- Modal for Plan Selection -->
    <div id="plan-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-container bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform scale-95">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 id="modal-title" class="text-xl font-semibold">Select a Plan</h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="mt-4 max-h-60 overflow-y-auto">
                <!-- Plan options will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const form = document.getElementById('persona-form');
        const generateBtn = document.getElementById('generate-btn');
        const profileOutput = document.getElementById('profile-output');
        const profileContent = document.getElementById('profile-content');
        const loader = document.getElementById('loader');
        const incomeSlider = document.getElementById('income-slider');
        const incomeValueDisplay = document.getElementById('income-value');
        const incomeSurplusIndicator = document.getElementById('income-surplus-indicator');
        const expenseFileInput = document.getElementById('expense-file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const pasteExpensesArea = document.getElementById('paste-expenses');
        const parsePasteBtn = document.getElementById('parse-paste-btn');
        const zipCodeInput = document.getElementById('zip-code');
        const zipError = document.getElementById('zip-error');
        const planModal = document.getElementById('plan-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Initial Setup
        updateSurplusIndicator();

        // Keyword map for parsing
        const expenseKeywordMap = {
            'mortgage': 'rent', 'nationstar': 'rent', 'mr cooper': 'rent',
            'auto loan': 'vehicle-payment', 'honda': 'vehicle-payment', 'jpmcb': 'vehicle-payment',
            'auto insurance': 'auto-insurance', 'car insurance': 'auto-insurance',
            'fuel': 'fuel', 'gas': 'fuel',
            'electric': 'utilities', 'utilities': 'utilities',
            'water': 'water', 'sewer': 'water', 'trash': 'water',
            'internet': 'internet', 'cable': 'internet', 'tv': 'internet', 'verizon': 'internet', 'comcast': 'internet', 'xfinity': 'internet',
            'phone': 'phone', 'cell': 'phone', 't-mobile': 'phone', 'at&t': 'phone',
            'groceries': 'groceries', 'hygiene': 'groceries', 'cleaning': 'groceries',
            'dining': 'dining', 'restaurants': 'dining',
            'health insurance': 'health-insurance',
            'prescriptions': 'prescriptions', 'medicine': 'prescriptions',
            'family': 'family-support',
            'tax': 'taxes', 'irs': 'taxes',
            'grooming': 'grooming', 'haircut': 'grooming',
            'pet': 'pets',
            'charity': 'charity', 'donation': 'charity',
            'saving': 'savings',
            'gym': 'recreation', 'recreation': 'recreation', 'storage': 'recreation',
            'credit card': 'credit-cards', 'cc payment': 'credit-cards', 'amex': 'credit-cards', 'apple card': 'credit-cards', 'capital one': 'credit-cards'
        };

        // --- Event Listeners ---

        // Update indicators on input change
        incomeSlider.addEventListener('input', () => {
            incomeValueDisplay.textContent = `$${incomeSlider.value}`;
            updateSurplusIndicator();
        });
        document.querySelectorAll('.expense-input').forEach(input => {
            input.addEventListener('input', updateSurplusIndicator);
        });

        // File Upload Handler
        expenseFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                fileNameDisplay.textContent = 'No file chosen';
                return;
            }
            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                parseExpenseText(e.target.result);
            };
            reader.readAsText(file);
        });
        
        // Paste Text Handler
        parsePasteBtn.addEventListener('click', () => {
            const text = pasteExpensesArea.value;
            if (text) {
                parseExpenseText(text);
                pasteExpensesArea.value = 'Parsed!';
                setTimeout(() => { pasteExpensesArea.value = ''; }, 2000);
            }
        });

        // Main form submission
        form.addEventListener('submit', handleFormSubmit);

        // Modal close buttons
        modalCloseBtn.addEventListener('click', closeModal);
        planModal.addEventListener('click', (e) => {
            if (e.target === planModal) closeModal();
        });

        // "Get Avg/Plans" buttons
        document.querySelectorAll('.get-avg-btn').forEach(button => {
            button.addEventListener('click', handleGetAverageClick);
        });

        // --- Core Functions ---

        /**
         * Parses text (from file or paste) and populates expense fields.
         * @param {string} text - The text content to parse.
         */
        function parseExpenseText(text) {
            document.querySelectorAll('.expense-input').forEach(input => input.value = '');
            const lines = text.split('\n');
            lines.forEach(line => {
                if (line.trim() === '' || line.toLowerCase().includes('account name')) return;
                
                const lowerLine = line.toLowerCase();
                
                // New Parsing Logic: Find all numbers, use the last one.
                const numberMatches = line.match(/(\$)?[\d,]+(\.\d{2})?/g);
                if (!numberMatches || numberMatches.length === 0) return;

                const lastNumberStr = numberMatches[numberMatches.length - 1];
                const amount = parseFloat(lastNumberStr.replace(/[\$,]/g, ''));

                if (isNaN(amount)) return;

                for (const keyword in expenseKeywordMap) {
                    if (lowerLine.includes(keyword)) {
                        const inputId = expenseKeywordMap[keyword];
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            const existingValue = parseFloat(inputElement.value) || 0;
                            inputElement.value = (existingValue + amount).toFixed(2);
                        }
                        return; // Move to the next line after finding a match
                    }
                }
            });
            updateSurplusIndicator(); // Update the live indicator after parsing
        }

        /**
         * Updates the live surplus/shortfall indicator based on current income and expenses.
         */
        function updateSurplusIndicator() {
            const income = parseFloat(incomeSlider.value) || 0;
            let totalExpenses = 0;
            document.querySelectorAll('.expense-input').forEach(input => {
                totalExpenses += parseFloat(input.value) || 0;
            });

            const surplus = income - totalExpenses;

            if (surplus >= 0) {
                incomeSurplusIndicator.textContent = `+$${surplus.toFixed(2)} Surplus`;
                incomeSurplusIndicator.className = 'text-center text-sm font-medium mt-2 p-2 rounded-md bg-green-100 text-green-800';
            } else {
                incomeSurplusIndicator.textContent = `-$${Math.abs(surplus).toFixed(2)} Shortfall`;
                incomeSurplusIndicator.className = 'text-center text-sm font-medium mt-2 p-2 rounded-md bg-red-100 text-red-800';
            }
        }

        /**
         * Handles the click event for fetching average costs or plans.
         * @param {Event} event - The click event.
         */
        async function handleGetAverageClick(event) {
            const button = event.currentTarget;
            const zip = zipCodeInput.value.trim();
            if (!/^\d{5}$/.test(zip)) {
                zipError.textContent = 'Please enter a valid 5-digit zip code to get estimates.';
                zipError.classList.remove('hidden');
                return;
            }
            zipError.classList.add('hidden');

            const spinner = button.querySelector('.spinner-tiny');
            const buttonText = button.querySelector('span:not(.spinner-tiny)');
            spinner.classList.remove('hidden');
            buttonText.classList.add('hidden');
            button.disabled = true;

            const type = button.dataset.type;
            const targetId = button.dataset.target;
            const brandSourceId = button.dataset.brandSource;
            const brand = brandSourceId ? document.getElementById(brandSourceId).value.trim() : '';

            // If it's a branded service, fetch plans. Otherwise, get a single average.
            if (brand) {
                const prompt = `List 3 common monthly plans for ${brand} ${type} in zip code ${zip}, from cheapest to most expensive.`;
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "plan_name": { "type": "STRING" },
                            "monthly_cost": { "type": "NUMBER" }
                        },
                        required: ["plan_name", "monthly_cost"]
                    }
                };
                try {
                    const plans = await callGeminiForJson(prompt, schema);
                    showPlanModal(plans, targetId, `${brand} ${type} Plans`);
                } catch (error) {
                    console.error("Plan fetch error:", error);
                }
            } else {
                // Fetch single average for non-branded utilities
                const prompt = `What is the average monthly cost for ${type} for a typical household in zip code ${zip}?`;
                const schema = {
                    type: "OBJECT",
                    properties: { "average_cost": { "type": "NUMBER" } },
                    required: ["average_cost"]
                };
                try {
                    const result = await callGeminiForJson(prompt, schema);
                    document.getElementById(targetId).value = result.average_cost.toFixed(2);
                    updateSurplusIndicator();
                } catch (error) {
                    console.error("Average cost fetch error:", error);
                }
            }
            spinner.classList.add('hidden');
            buttonText.classList.remove('hidden');
            button.disabled = false;
        }

        /**
         * Populates and displays the plan selection modal.
         * @param {Array} plans - Array of plan objects.
         * @param {string} targetId - The ID of the input field to update.
         * @param {string} title - The title for the modal.
         */
        function showPlanModal(plans, targetId, title) {
            modalTitle.textContent = title;
            modalBody.innerHTML = ''; // Clear previous options
            if (plans && plans.length > 0) {
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                plans.forEach(plan => {
                    const item = document.createElement('li');
                    item.className = 'p-3 border rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                    item.innerHTML = `<span>${plan.plan_name}</span> <span class="font-semibold">$${plan.monthly_cost.toFixed(2)}</span>`;
                    item.addEventListener('click', () => {
                        document.getElementById(targetId).value = plan.monthly_cost.toFixed(2);
                        updateSurplusIndicator();
                        closeModal();
                    });
                    list.appendChild(item);
                });
                modalBody.appendChild(list);
            } else {
                modalBody.textContent = 'Could not find specific plans. Please enter a value manually.';
            }
            planModal.classList.remove('hidden');
            planModal.querySelector('.modal-container').classList.add('scale-100');
        }

        function closeModal() {
            const container = planModal.querySelector('.modal-container');
            container.classList.remove('scale-100');
            container.classList.add('scale-95');
            planModal.classList.add('hidden');
        }

        /**
         * Handles the main form submission to generate the persona profile.
         * @param {Event} e - The form submission event.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            profileOutput.classList.remove('hidden');
            profileContent.innerHTML = '';
            loader.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const reason = document.getElementById('hardship-reason').value;
            const income = parseFloat(document.getElementById('income-slider').value) || 0;
            const expenses = {};
            let totalExpenses = 0;

            document.querySelectorAll('.expense-input').forEach(input => {
                const value = parseFloat(input.value) || 0;
                const label = document.querySelector(`label[for='${input.id}']`).textContent;
                expenses[label] = value;
                totalExpenses += value;
            });

            const shortfall = income - totalExpenses;

            const prompt = `
                Generate a short, empathetic persona profile for someone facing financial hardship.
                The primary reason for their hardship is: "${reason}".
                Their monthly income is $${income}.
                Their total monthly expenses are $${totalExpenses}.
                This leaves them with a monthly ${shortfall >= 0 ? 'surplus' : 'shortfall'} of $${Math.abs(shortfall)}.
                Here is a breakdown of their key expenses: ${JSON.stringify(expenses)}.
                Based on these numbers and the reason for hardship, create a realistic and compelling narrative. Make it about 2-3 paragraphs long. Do not repeat the dollar amounts from the expense breakdown in the narrative, but use the types of expenses to inform the story. The story should feel personal and human. Give the person a name.
            `;

            try {
                const generatedText = await callGeminiApi(prompt);
                displayProfile(income, totalExpenses, shortfall, expenses, generatedText, reason);
            } catch (error) {
                console.error("Error generating profile:", error);
                profileContent.innerHTML = `<div class="text-red-500 text-center">Sorry, something went wrong. Please try again.</div>`;
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // --- API Call Functions ---

        async function callApi(payload) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            return await response.json();
        }

        async function callGeminiApi(prompt) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const result = await callApi(payload);
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return result.candidates[0].content.parts[0].text;
            }
            return "Could not generate a narrative for this persona.";
        }

        async function callGeminiForJson(prompt, schema) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            const result = await callApi(payload);
             if (result.candidates?.[0]?.content?.parts?.[0]) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("Could not parse JSON from API response.");
        }

        /**
         * Displays the final generated profile in the output area.
         */
        function displayProfile(income, totalExpenses, shortfall, expenses, narrative, reason) {
            let expenseListHtml = '';
            for (const [key, value] of Object.entries(expenses)) {
                expenseListHtml += `<li class="flex justify-between py-1"><span class="text-gray-600">${key}</span><span>$${value.toFixed(2)}</span></li>`;
            }

            const shortfallClass = shortfall < 0 ? 'text-red-600' : 'text-green-600';
            const shortfallLabel = shortfall < 0 ? 'Monthly Shortfall' : 'Monthly Surplus';

            profileContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Persona Profile</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Reason for Hardship</h3>
                    <p class="text-sm text-indigo-600 font-medium mb-2">${reason}</p>
                    <p class="text-gray-600 whitespace-pre-wrap">${narrative}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Financial Summary</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex justify-between py-2 border-b"><span class="font-medium text-gray-700">Total Monthly Income</span><span class="font-medium text-green-600">$${income.toFixed(2)}</span></li>
                        <li class="flex justify-between py-2 border-b"><span class="font-medium text-gray-700">Total Monthly Expenses</span><span class="font-medium text-red-600">$${totalExpenses.toFixed(2)}</span></li>
                        <li class="flex justify-between py-2 font-bold text-lg"><span>${shortfallLabel}</span><span class="${shortfallClass}">$${Math.abs(shortfall).toFixed(2)}</span></li>
                    </ul>
                </div>
                <div class="mt-6">
                     <h3 class="text-lg font-semibold text-gray-800 mb-3">Complete Expense Breakdown</h3>
                     <ul class="text-sm divide-y divide-gray-200">${expenseListHtml}</ul>
                </div>
            `;
        }
    </script>

</body>
</html>
